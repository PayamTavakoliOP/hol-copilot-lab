name: CD - Continuous Deployment

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  deployments: write
  id-token: write

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.dailyharvest.example.com
    permissions:
      contents: read
      deployments: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.x"
          cache: "npm"
          cache-dependency-path: eCommApp/package-lock.json

      - name: Install dependencies
        working-directory: eCommApp
        run: npm ci --prefer-offline --no-audit

      - name: Build for staging
        working-directory: eCommApp
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_URL: ${{ secrets.STAGING_API_URL }}

      - name: Run smoke tests
        working-directory: eCommApp
        run: npm run test:e2e || true
        continue-on-error: true

      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying to staging environment..."
          echo "üì¶ Build artifacts ready for deployment"
          # Add your deployment commands here (e.g., Azure Static Web Apps, Netlify, Vercel, etc.)
          # az staticwebapp deploy --app-name ${{ secrets.AZURE_STATIC_WEB_APP_NAME }} --source-dir eCommApp/dist

      - name: Health check
        run: |
          echo "üè• Running health checks on staging..."
          # curl -f https://staging.dailyharvest.example.com/health || exit 1

      - name: Notify deployment
        if: success()
        run: echo "‚úÖ Staging deployment successful!"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://dailyharvest.example.com
    permissions:
      contents: read
      deployments: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.x"
          cache: "npm"
          cache-dependency-path: eCommApp/package-lock.json

      - name: Install dependencies
        working-directory: eCommApp
        run: npm ci --prefer-offline --no-audit

      - name: Build for production
        working-directory: eCommApp
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_URL: ${{ secrets.PRODUCTION_API_URL }}

      - name: Generate production SBOM
        working-directory: eCommApp
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom-production.json

      - name: Sign artifacts
        run: |
          echo "üîê Signing production artifacts..."
          # Add artifact signing here

      - name: Deploy to production
        run: |
          echo "üöÄ Deploying to production environment..."
          echo "üì¶ Signed build artifacts ready for deployment"
          # Add your production deployment commands here

      - name: Health check
        run: |
          echo "üè• Running health checks on production..."
          # curl -f https://dailyharvest.example.com/health || exit 1

      - name: Create deployment tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "v$(date +'%Y.%m.%d-%H%M%S')" -m "Production deployment"
          # git push origin --tags

      - name: Notify deployment
        if: success()
        run: echo "‚úÖ Production deployment successful!"

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure()
    environment:
      name: production
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Rollback to previous version
        run: |
          echo "‚èÆÔ∏è  Rolling back to previous version..."
          # Add rollback commands here
